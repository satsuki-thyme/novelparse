function novelparse(e){async function r(e){return"unprocessed"===c?e.split(/\r?\n|\r(?!\n)/):"delete-together"===c?e.replace(/\/\*[\s\S]*\*\/(\r?\n|\r(?!\n)|$)/g,"").split(/\r?\n|\r(?!\n)/).filter(e=>!/^#+ |^[ \t]*[\-+*] |^[ \t]*\d+\. |^\/\//.test(e)):void 0}async function u(e){async function r(e){return new Promise(r=>{function u(c){function l(t){n&&!$?t&&/^.+$/.test(e[F+1])?(e[F]=`${e[F].replace(/^[　 ]*/,"")}`,F++,u()):t&&/^$/.test(e[F+1])?(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,n=!1,F++,u()):t?(F++,u()):(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,r(e)):n||$?!n&&$?(t&&""!==o&&!i.test(e[F])&&D.test(e[F])&&(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,$=!1,F++,u()),!t||""===o||i.test(e[F])||D.test(e[F])||(e[F]=`${e[F].replace(/^[　 ]*/,"")}`,F++,u(o)),t||(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,r(e))):(console.log("想定外の入力がありました"),F++,u()):t&&""===o&&/^(?<!\\)[　 ].*$/.test(e[F])&&/^(?<!\\)[　 ].*$/.test(e[F+1])?(e[F]=`${s}<p>${e[F]}`,n=!0,F++,u(o)):t&&""===o&&/^(?<!\\)[　 ].*$/.test(e[F])&&!/^(?<!\\)[　 ].*$/.test(e[F+1])?(e[F]=`${s}<p>${e[F]}</p>`,F++,u()):t&&""===o&&/^$/.test(e[F])?(e[F]=`${s}<p><br></p>`,F++,u()):t&&""===o&&/^([^　 ]|(?<=\\)[　 ]).*$/.test(e[F])?(e[F]=`${s}<p>${e[F].replace(/^\\/,"")}</p>`,F++,u()):t&&""!==o&&!/^$/.test(e[F])&&e[F].search(i)<e[F].search(D)?(e[F]=`${s}<p>${e[F]}</p>`,F++,u()):t&&""!==o&&!/^$/.test(e[F])&&e[F].search(i)>=e[F].search(D)?(e[F]=`${s}<p>${e[F]}`,$=!0,F++,u(o)):t?(console.log("想定外の入力がありました"),F++,u()):(e[F]=`<p>${e[F].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,r(e))}let s=0!==F?a:"",o=void 0!==c?c:t.test(e[F])?e[F].match(t)[0]:"",g=""!==o?p.filter(e=>e[0]===o)[0][1]:"",i=new RegExp(`^${o}`),D=new RegExp(`${g}$`);F!==e.length-1?l(!0):l(!1)}let F=0,n=!1,$=!1;u()})}let u=p.map(e=>e[0]).join(""),t=new RegExp(`^(?<![　 ])[${u}]`);return"normal"===n?e.map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===n?r(e):"raw"===n||"normal"!==n&&"few"!==n?e:void 0}function t(e){return e=e.join(a),"parse"===$?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===$?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===$?e:void 0}let F=void 0===e.src?"":e.src,n=void 0===e.newLineMode?"normal":e.newLineMode,$=void 0===e.rubyMode?"parse":e.rubyMode,p=(e.parenthesis,[["「","」"],["『","』"],["（","）"]]),c=void 0===e.comment?"delete-together":e.comment,l={n:(F.match(/(?<!\r)\n/g)||[]).length,r:(F.match(/\r(?!\n)/g)||[]).length,rn:(F.match(/\r\n/g)||[]).length},a=l.n>=l.r?l.n>=l.rn?"\n":"\r\n":l.r<=l.rn?"\r\n":"\r";return r(F).then(e=>u(e)).then(e=>t(e))}