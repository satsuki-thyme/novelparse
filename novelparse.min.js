function novelparse(e){function r(e){return"unprocessed"===s||"unprocessed"!==s&&"delete-together"!==s?e.split(/\r?\n|\r(?!\n)/):"delete-together"===s?e.replace(/\/\*[\s\S]*?(\*\/|$)/g,"").split(/\r?\n|\r(?!\n)/).filter(e=>!/^#+ |^[ \t]*[\-+*] |^[ \t]*\d+\. |^\/\//.test(e)):void 0}async function t(e){async function r(e){return new Promise(r=>{function t(s){function l(p){a&&!c?p&&/^.+$/.test(e[n+1])?(e[n]=e[n].replace(/^[　 ]*/,""),n++,t()):p&&/^$/.test(e[n+1])?(e[n]=`${e[n].replace(/^[　 ]*/,"")}</p>`,a=!1,n++,t()):p?(n++,t()):(e[n]=`${e[n].replace(/^[　 ]*/,"")}</p>`,r(e)):a||c?!a&&c?(p&&""!==u&&!x.test(e[n])&&d.test(e[n])&&(e[n]=`${e[n].replace(/^[　 ]*/,"")}</p>`,c=!1,n++,t()),!p||""===u||x.test(e[n])||d.test(e[n])||(e[n]=`${e[n].replace(/^[　 ]*/,"")}`,n++,t(u)),p||(e[n]=`${e[n].replace(/^[　 ]*/,"")}</p>`,r(e))):(console.log("想定外の入力がありました"),n++,t()):p&&""===u&&/^(?<!\\)[　 ].*$/.test(e[n])&&/^(?<!\\)[　 ].*$/.test(e[n+1])?(e[n]=`${g}<p>${e[n]}`,a=!0,n++,t(u)):p&&""===u&&/^(?<!\\)[　 ].*$/.test(e[n])&&!/^(?<!\\)[　 ].*$/.test(e[n+1])?(e[n]=`${g}<p>${e[n]}</p>`,n++,t()):p&&""===u&&/^$/.test(e[n])?(e[n]=`${g}<p><br></p>`,n++,t()):p&&""===u&&/^([^　 ]|(?<=\\)[　 ]).*$/.test(e[n])?(e[n]=`${g}<p>${e[n].replace(/^\\/,"")}</p>`,n++,t()):p&&""!==u&&!/^$/.test(e[n])&&e[n].search(x)<e[n].search(d)?(e[n]=`${g}<p>${e[n]}</p>`,n++,t()):p&&""!==u&&!/^$/.test(e[n])&&e[n].search(x)>=e[n].search(d)?(e[n]=`${g}<p>${e[n]}`,c=!0,n++,t(u)):p?(console.log("想定外の入力がありました"),n++,t()):(e[n]=`<p>${e[n].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,r(e))}let g=0!==n?o:"",u=void 0!==s?s:p.test(e[n])?e[n].match(p)[0]:"",i=""!==u?$.filter(e=>e[0]===u)[0][1]:"",x=new RegExp(`^${u}`),d=new RegExp(`${i}$`);n!==e.length-1?l(!0):l(!1)}let n=0,a=!1,c=!1;t()})}let t=$.map(e=>e[0]).join(""),p=new RegExp(`^(?<![　 ])[${t}]`);return"normal"===a?e.map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===a?r(e):"raw"===a||"normal"!==a&&"few"!==a?e:void 0}function p(e){return e=e.join(""),"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"open"===c?e.replace(/[|｜].+?《(.+?)》/g,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+《(.+?)》/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#.+?__(.+?)__#/g,"$1"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let n=void 0===e.src?"":e.src,a=void 0===e.newLineMode?"normal":e.newLineMode,c=void 0===e.rubyMode?"parse":e.rubyMode,$=(e.parenthesis,[["「","」"],["『","』"],["（","）"]]),s=void 0===e.comment?"delete-together":e.comment,l={n:(n.match(/(?<!\r)\n/g)||[]).length,r:(n.match(/\r(?!\n)/g)||[]).length,rn:(n.match(/\r\n/g)||[]).length},o=l.n>=l.r?l.n>=l.rn?"\n":"\r\n":l.r<=l.rn?"\r\n":"\r";return t(r(n)).then(e=>p(e))}