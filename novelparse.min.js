function novelparse(e){function r(e){return"unprocessed"===s||"unprocessed"!==s&&"delete-together"!==s?e.split(/\r?\n|\r(?!\n)/):"delete-together"===s?e.replace(/\/\*[\s\S]*\*\/(\r?\n|\r(?!\n)|$)/g,"").split(/\r?\n|\r(?!\n)/).filter(e=>!/^#+ |^[ \t]*[\-+*] |^[ \t]*\d+\. |^\/\//.test(e)):void 0}async function t(e){async function r(e){return new Promise(r=>{function t(s){function l(n){a&&!c?n&&/^.+$/.test(e[p+1])?(e[p]=`${e[p].replace(/^[　 ]*/,"")}`,p++,t()):n&&/^$/.test(e[p+1])?(e[p]=`${e[p].replace(/^[　 ]*/,"")}</p>`,a=!1,p++,t()):n?(p++,t()):(e[p]=`${e[p].replace(/^[　 ]*/,"")}</p>`,r(e)):a||c?!a&&c?(n&&""!==i&&!d.test(e[p])&&h.test(e[p])&&(e[p]=`${e[p].replace(/^[　 ]*/,"")}</p>`,c=!1,p++,t()),!n||""===i||d.test(e[p])||h.test(e[p])||(e[p]=`${e[p].replace(/^[　 ]*/,"")}`,p++,t(i)),n||(e[p]=`${e[p].replace(/^[　 ]*/,"")}</p>`,r(e))):(console.log("想定外の入力がありました"),p++,t()):n&&""===i&&/^(?<!\\)[　 ].*$/.test(e[p])&&/^(?<!\\)[　 ].*$/.test(e[p+1])?(e[p]=`${u}<p>${e[p]}`,a=!0,p++,t(i)):n&&""===i&&/^(?<!\\)[　 ].*$/.test(e[p])&&!/^(?<!\\)[　 ].*$/.test(e[p+1])?(e[p]=`${u}<p>${e[p]}</p>`,p++,t()):n&&""===i&&/^$/.test(e[p])?(e[p]=`${u}<p><br></p>`,p++,t()):n&&""===i&&/^([^　 ]|(?<=\\)[　 ]).*$/.test(e[p])?(e[p]=`${u}<p>${e[p].replace(/^\\/,"")}</p>`,p++,t()):n&&""!==i&&!/^$/.test(e[p])&&e[p].search(d)<e[p].search(h)?(e[p]=`${u}<p>${e[p]}</p>`,p++,t()):n&&""!==i&&!/^$/.test(e[p])&&e[p].search(d)>=e[p].search(h)?(e[p]=`${u}<p>${e[p]}`,c=!0,p++,t(i)):n?(console.log("想定外の入力がありました"),p++,t()):(e[p]=`<p>${e[p].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,r(e))}let u=0!==p?o:"",i=void 0!==s?s:n.test(e[p])?e[p].match(n)[0]:"",g=""!==i?$.filter(e=>e[0]===i)[0][1]:"",d=new RegExp(`^${i}`),h=new RegExp(`${g}$`);p!==e.length-1?l(!0):l(!1)}let p=0,a=!1,c=!1;t()})}let t=$.map(e=>e[0]).join(""),n=new RegExp(`^(?<![　 ])[${t}]`);return"normal"===a?e.map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===a?r(e):"raw"===a||"normal"!==a&&"few"!==a?e:void 0}function n(e){return e=e.join(o),"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![「」『』【】《》〈〉〔〕〘〙〖〗。、・々〆〃—〜〄〇〓])\p{scx=Han}+)《(.+?)》/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![「」『』【】《》〈〉〔〕〘〙〖〗。、・々〆〃—〜〄〇〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![「」『』【】《》〈〉〔〕〘〙〖〗。、・々〆〃—〜〄〇〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/((?![「」『』【】《》〈〉〔〕〘〙〖〗。、・々〆〃—〜〄〇〓])\p{scx=Han}+)《(.+?)》/g,"$1").replace(/((?![「」『』【】《》〈〉〔〕〘〙〖〗。、・々〆〃—〜〄〇〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/((?![「」『』【】《》〈〉〔〕〘〙〖〗。、・々〆〃—〜〄〇〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let p=void 0===e.src?"":e.src,a=void 0===e.newLineMode?"normal":e.newLineMode,c=void 0===e.rubyMode?"parse":e.rubyMode,$=(e.parenthesis,[["「","」"],["『","』"],["（","）"]]),s=void 0===e.comment?"delete-together":e.comment,l={n:(p.match(/(?<!\r)\n/g)||[]).length,r:(p.match(/\r(?!\n)/g)||[]).length,rn:(p.match(/\r\n/g)||[]).length},o=l.n>=l.r?l.n>=l.rn?"\n":"\r\n":l.r<=l.rn?"\r\n":"\r";return t(r(p)).then(e=>n(e))}