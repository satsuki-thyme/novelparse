function novelparse(u,r,F){let e="",t=u,p=u.match(/\r\n/),$=u.match(/(?<!\r)\n/);p&&$&&p.length>$.length?(e="\r\n",t.replace(/\r?\n/g,e)):(e="\n",t.replace(/\r?\n/g,e));let l=new RegExp(`${e}(${e}*)`,"g");return void 0!==F&&!0!==F||(t=t.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]《(.+?)》/g,"《$1》").replace(/[|｜]\((.+?)\)/g,"($1)").replace(/[|｜]（(.+?)）/g,"（$1）").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>")),"few"===r&&(t=t.replace(l,"$1")),t.split(e).map(u=>/^$/.test(u)?"<p><br></p>":`<p>${u}</p>`).join(e)}