function novelparse(e,u,F,r){async function p(e){async function u(e){return new Promise(u=>{function F(c){let s=0!==r?n:"",D=void 0!==c?c:p.test(e[r])?e[r].match(p)[0]:"",g=""!==D?l.filter(e=>e[0]===D)[0][1]:"",i=new RegExp(`${D}`),o=new RegExp(`${g}`);r===e.length-1&&(a=!1),t&&!$&&(a&&/^[　 ]*.+$/.test(e[r+1])&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}`,r++,F()),a&&/^$/.test(e[r+1])&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,t=!1,r++,F()),a||(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,u(e))),t||$||(a&&""===D&&!/^$/.test(e[r])&&/^　/.test(e[r+1])&&(e[r]=`${s}<p>${e[r]}`,t=!0,r++,F(D)),a&&""===D&&!/^$/.test(e[r])&&/^$/.test(e[r+1])&&(e[r]=`${s}<p>${e[r]}</p>`,r++,F()),a&&""===D&&/^$/.test(e[r])&&(e[r]=`${s}<p><br></p>`,r++,F()),a&&""!==D&&!/^$/.test(e[r])&&e[r].search(i)<e[r].search(o)&&(e[r]=`${s}<p>${e[r]}</p>`,r++,F()),a&&""!==D&&!/^$/.test(e[r])&&e[r].search(i)>=e[r].search(o)&&(e[r]=`${s}<p>${e[r]}`,$=!0,r++,F(D)),a||(e[r]=`<p>${e[r].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,u(e))),!t&&$&&(a&&""!==D&&e[r].search(i)<e[r].search(o)&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,$=!1,r++,F()),a&&""!==D&&e[r].search(i)<0&&e[r].search(o)<0&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}`,r++,F(D)),a||(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,u(e)))}let r=0,t=!1,$=!1,a=!0;F()})}let F=l.map(e=>e=e[0]).join(""),r=l.map(e=>e=e[1]).join(""),p=new RegExp(`[${F}]`);new RegExp(`[${r}]`);return"normal"===a?e.split(n).map(e=>e=e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===a?u(e.split(n)):"normal"!==a&&"few"!==a?e.split(n):void 0}function t(e){return"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let $=void 0===e?"":e,a=void 0===u?"normal":u,c=void 0===F?"parse":F,l=void 0===r?[["「","」"],["『","』"],["（","）"]]:r,n="",s=$.match(/\r\n/),D=$.match(/(?<!\r)\n/);return s&&D&&s.length>D.length?(n="\r\n",$.replace(/\r?\n/g,n)):(n="\n",$.replace(/\r?\n/g,n)),p($).then(e=>t(e.join("")))}