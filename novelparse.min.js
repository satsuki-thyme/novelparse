function novelparse(e,u,r,F,t){function p(e){return"unprocessed"===o?e:"delete"===o?e.filter(e=>!/^#+ |^[ \t]*[\-+*] |^[ \t]*\d+\. /.test(e)):void 0}async function $(e){async function u(e){return new Promise(u=>{function r(n){function c(F){p&&!$?F&&/^.+$/.test(e[t+1])?(e[t]=`${e[t].replace(/^[　 ]*/,"")}`,t++,r()):F&&/^$/.test(e[t+1])?(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,p=!1,t++,r()):F?(t++,r()):(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,u(e)):p||$?!p&&$?(F&&""!==a&&!g.test(e[t])&&i.test(e[t])&&(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,$=!1,t++,r()),!F||""===a||g.test(e[t])||i.test(e[t])||(e[t]=`${e[t].replace(/^[　 ]*/,"")}`,t++,r(a)),F||(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,u(e))):(console.log("想定外の入力がありました"),t++,r()):F&&""===a&&/^(?<!\\)[　 ].*$/.test(e[t])&&/^(?<!\\)[　 ].*$/.test(e[t+1])?(e[t]=`${l}<p>${e[t]}`,p=!0,t++,r(a)):F&&""===a&&/^(?<!\\)[　 ].*$/.test(e[t])&&!/^(?<!\\)[　 ].*$/.test(e[t+1])?(e[t]=`${l}<p>${e[t]}</p>`,t++,r()):F&&""===a&&/^$/.test(e[t])?(e[t]=`${l}<p><br></p>`,t++,r()):F&&""===a&&/^([^　 ]|(?<=\\)[　 ]).*$/.test(e[t])?(e[t]=`${l}<p>${e[t].replace(/^\\/,"")}</p>`,t++,r()):F&&""!==a&&!/^$/.test(e[t])&&e[t].search(g)<e[t].search(i)?(e[t]=`${l}<p>${e[t]}</p>`,t++,r()):F&&""!==a&&!/^$/.test(e[t])&&e[t].search(g)>=e[t].search(i)?(e[t]=`${l}<p>${e[t]}`,$=!0,t++,r(a)):F?(console.log("想定外の入力がありました"),t++,r()):(e[t]=`<p>${e[t].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,u(e))}let l=0!==t?D:"",a=void 0!==n?n:F.test(e[t])?e[t].match(F)[0]:"",o=""!==a?s.filter(e=>e[0]===a)[0][1]:"",g=new RegExp(`^${a}`),i=new RegExp(`${o}$`);t!==e.length-1?c(!0):c(!1)}let t=0,p=!1,$=!1;r()})}let r=s.map(e=>e[0]).join(""),F=new RegExp(`^(?<![　 ])[${r}]`);return"unprocessed"===l?e.map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===l?u(e):"unprocessed"!==l&&"few"!==l?e:void 0}function n(e){return e=e.join(""),"parse"===a?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===a?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===a?e:void 0}let c=void 0===e?"":e,l=void 0===u?"unprocessed":u,a=void 0===r?"parse":r,s=[["「","」"],["『","』"],["（","）"]],o=void 0===t?"unprocessed":t,g={n:(c.match(/(?<!\r)\n/g)||[]).length,r:(c.match(/\r(?!\n)/g)||[]).length,rn:(c.match(/\r\n/g)||[]).length},D=g.n>=g.r?g.n>=g.rn?"\n":"\r\n":g.r<=g.rn?"\r\n":"\r";return c=c.split(/\r?\n|\r(?!\n)/),$(c).then(e=>p(e)).then(e=>n(e))}