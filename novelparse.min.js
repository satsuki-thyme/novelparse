function novelparse(e,r,u,F){async function t(e){async function r(e){return new Promise(r=>{function u(n){function a(t){$&&!p?t&&/^.+$/.test(e[F+1])?(e[F]=`${e[F].replace(/^[　 ]*/,"")}`,F++,u()):t&&/^$/.test(e[F+1])?(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,$=!1,F++,u()):t?(F++,u()):(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,r(e)):$||p?!$&&p?(t&&""!==o&&e[F].search(D)<e[F].search(i)&&(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,p=!1,F++,u()),t&&""!==o&&e[F].search(D)<0&&e[F].search(i)<0&&(e[F]=`${e[F].replace(/^[　 ]*/,"")}`,F++,u(o)),t||(e[F]=`${e[F].replace(/^[　 ]*/,"")}</p>`,r(e))):(console.log("想定外の入力がありました"),F++,u()):!t||""!==o||/^$/.test(e[F])||/^$/.test(e[F+1])?t&&""===o&&!/^$/.test(e[F])&&/^$/.test(e[F+1])?(e[F]=`${l}<p>${e[F]}</p>`,F++,u()):t&&""===o&&/^$/.test(e[F])?(e[F]=`${l}<p><br></p>`,F++,u()):t&&""!==o&&!/^$/.test(e[F])&&e[F].search(D)<e[F].search(i)?(e[F]=`${l}<p>${e[F]}</p>`,F++,u()):t&&""!==o&&!/^$/.test(e[F])&&e[F].search(D)>=e[F].search(i)?(e[F]=`${l}<p>${e[F]}`,p=!0,F++,u(o)):t?(console.log("想定外の入力がありました"),F++,u()):(e[F]=`<p>${e[F].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,r(e)):(e[F]=`${l}<p>${e[F]}`,$=!0,F++,u(o))}let l=0!==F?s:"",o=void 0!==n?n:t.test(e[F])?e[F].match(t)[0]:"",g=""!==o?c.filter(e=>e[0]===o)[0][1]:"",D=new RegExp(`${o}`),i=new RegExp(`${g}`);F!==e.length-1?a(!0):a(!1)}let F=0,$=!1,p=!1;u()})}let u=c.map(e=>e=e[0]).join(""),F=c.map(e=>e=e[1]).join(""),t=new RegExp(`^(?<![　 ])[${u}]`);new RegExp(`[${F}]$`);return"normal"===n?e.split(s).map(e=>e=e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===n?r(e.split(s)):"normal"!==n&&"few"!==n?e.split(s):void 0}function $(e){return"parse"===a?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===a?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===a?e:void 0}let p=void 0===e?"":e,n=void 0===r?"normal":r,a=void 0===u?"parse":u,c=void 0===F?[["「","」"],["『","』"],["（","）"]]:F,l={n:(p.match(/(?<!\r)\n/g)||[]).length,r:(p.match(/\r(?!\n)/g)||[]).length,rn:(p.match(/\r\n/g)||[]).length},s=l.n>=l.r?l.n>=l.rn?"\n":"\r\n":l.r<=l.rn?"\r\n":"\r";return p=p.replace(/\r?\n|\r(?!\n)/g,s),t(p).then(e=>$(e.join("")))}