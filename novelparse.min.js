function novelparse(e,u,F,r){async function t(e){async function u(e){return new Promise(u=>{function F(a){function c(t){p&&!$?t&&/^.+$/.test(e[r+1])?(e[r]=`${e[r].replace(/^[　 ]*/,"")}`,r++,F()):t&&/^$/.test(e[r+1])?(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,p=!1,r++,F()):t?(r++,F()):(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,u(e)):p||$?!p&&$?(t&&""!==o&&e[r].search(g)<e[r].search(i)&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,$=!1,r++,F()),t&&""!==o&&e[r].search(g)<0&&e[r].search(i)<0&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}`,r++,F(o)),t||(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,u(e))):(console.log("想定外の入力がありました"),r++,F()):!t||""!==o||/^$/.test(e[r])||/^$/.test(e[r+1])?t&&""===o&&!/^$/.test(e[r])&&/^$/.test(e[r+1])?(e[r]=`${s}<p>${e[r]}</p>`,r++,F()):t&&""===o&&/^$/.test(e[r])?(e[r]=`${s}<p><br></p>`,r++,F()):t&&""!==o&&!/^$/.test(e[r])&&e[r].search(g)<e[r].search(i)?(e[r]=`${s}<p>${e[r]}</p>`,r++,F()):t&&""!==o&&!/^$/.test(e[r])&&e[r].search(g)>=e[r].search(i)?(e[r]=`${s}<p>${e[r]}`,$=!0,r++,F(o)):t?(console.log("想定外の入力がありました"),r++,F()):(e[r]=`<p>${e[r].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,u(e)):(e[r]=`${s}<p>${e[r]}`,p=!0,r++,F(o))}let s=0!==r?n:"",o=void 0!==a?a:t.test(e[r])?e[r].match(t)[0]:"",D=""!==o?l.filter(e=>e[0]===o)[0][1]:"",g=new RegExp(`${o}`),i=new RegExp(`${D}`);r!==e.length-1?c(!0):c(!1)}let r=0,p=!1,$=!1;F()})}let F=l.map(e=>e=e[0]).join(""),r=l.map(e=>e=e[1]).join(""),t=new RegExp(`^(?<![　 ])[${F}]`);new RegExp(`[${r}]$`);return"normal"===a?e.split(n).map(e=>e=e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===a?u(e.split(n)):"normal"!==a&&"few"!==a?e.split(n):void 0}function p(e){return"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let $=void 0===e?"":e,a=void 0===u?"normal":u,c=void 0===F?"parse":F,l=void 0===r?[["「","」"],["『","』"],["（","）"]]:r,n="",s=$.match(/\r\n/),o=$.match(/(?<!\r)\n/);return s&&o&&s.length>o.length?(n="\r\n",$.replace(/\r?\n/g,n)):(n="\n",$.replace(/\r?\n/g,n)),t($).then(e=>p(e.join("")))}