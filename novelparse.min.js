function novelparse(e,u,F,r){async function t(e){async function u(e){return new Promise(u=>{function F(a){function c(t){p&&!$?t&&/^[　 ]*.+$/.test(e[r+1])?(e[r]=`${e[r].replace(/^[　 ]*/,"")}`,r++,F()):t&&/^$/.test(e[r+1])?(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,p=!1,r++,F()):t||(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,u(e)):p||$?!p&&$&&(t&&""!==D&&e[r].search(i)<e[r].search(o)&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,$=!1,r++,F()),t&&""!==D&&e[r].search(i)<0&&e[r].search(o)<0&&(e[r]=`${e[r].replace(/^[　 ]*/,"")}`,r++,F(D)),t||(e[r]=`${e[r].replace(/^[　 ]*/,"")}</p>`,u(e))):t&&""===D&&!/^$/.test(e[r])&&/^　/.test(e[r+1])?(e[r]=`${s}<p>${e[r]}`,p=!0,r++,F(D)):t&&""===D&&!/^$/.test(e[r])&&/^$/.test(e[r+1])?(e[r]=`${s}<p>${e[r]}</p>`,r++,F()):t&&""===D&&/^$/.test(e[r])?(e[r]=`${s}<p><br></p>`,r++,F()):t&&""!==D&&!/^$/.test(e[r])&&e[r].search(i)<e[r].search(o)?(e[r]=`${s}<p>${e[r]}</p>`,r++,F()):t&&""!==D&&!/^$/.test(e[r])&&e[r].search(i)>=e[r].search(o)?(e[r]=`${s}<p>${e[r]}`,$=!0,r++,F(D)):t||(e[r]=`<p>${e[r].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,u(e))}let s=0!==r?n:"",D=void 0!==a?a:t.test(e[r])?e[r].match(t)[0]:"",g=""!==D?l.filter(e=>e[0]===D)[0][1]:"",i=new RegExp(`${D}`),o=new RegExp(`${g}`);r!==e.length-1?c(!0):c(!1)}let r=0,p=!1,$=!1;F()})}let F=l.map(e=>e=e[0]).join(""),r=l.map(e=>e=e[1]).join(""),t=new RegExp(`(?<![　 ])[${F}]`);new RegExp(`[${r}]`);return"normal"===a?e.split(n).map(e=>e=e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===a?u(e.split(n)):"normal"!==a&&"few"!==a?e.split(n):void 0}function p(e){return"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let $=void 0===e?"":e,a=void 0===u?"normal":u,c=void 0===F?"parse":F,l=void 0===r?[["「","」"],["『","』"],["（","）"]]:r,n="",s=$.match(/\r\n/),D=$.match(/(?<!\r)\n/);return s&&D&&s.length>D.length?(n="\r\n",$.replace(/\r?\n/g,n)):(n="\n",$.replace(/\r?\n/g,n)),t($).then(e=>p(e.join("")))}