function novelparse(e,u,r,F){async function t(e){async function u(e){return new Promise(u=>{function r(n){function l(F){$&&!p?F&&/^.+$/.test(e[t+1])?(e[t]=`${e[t].replace(/^[　 ]*/,"")}`,t++,r()):F&&/^$/.test(e[t+1])?(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,$=!1,t++,r()):F?(t++,r()):(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,u(e)):$||p?!$&&p?(F&&""!==o&&!D.test(e[t])&&i.test(e[t])&&(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,p=!1,t++,r()),!F||""===o||D.test(e[t])||i.test(e[t])||(e[t]=`${e[t].replace(/^[　 ]*/,"")}`,t++,r(o)),F||(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,u(e))):(console.log("想定外の入力がありました"),t++,r()):F&&""===o&&/^[　 ].*$/.test(e[t])&&/^[　 ].*$/.test(e[t+1])?(e[t]=`${c}<p>${e[t]}`,$=!0,t++,r(o)):F&&""===o&&/^[　 ].*$/.test(e[t])&&!/^[　 ].*$/.test(e[t+1])?(e[t]=`${c}<p>${e[t]}</p>`,t++,r()):F&&""===o&&/^$/.test(e[t])?(e[t]=`${c}<p><br></p>`,t++,r()):F&&""===o&&/^[^　 ].*$/.test(e[t])?(e[t]=`${c}<p>${e[t]}</p>`,t++,r()):F&&""!==o&&!/^$/.test(e[t])&&e[t].search(D)<e[t].search(i)?(e[t]=`${c}<p>${e[t]}</p>`,t++,r()):F&&""!==o&&!/^$/.test(e[t])&&e[t].search(D)>=e[t].search(i)?(e[t]=`${c}<p>${e[t]}`,p=!0,t++,r(o)):F?(console.log("想定外の入力がありました"),t++,r()):(e[t]=`<p>${e[t].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,u(e))}let c=0!==t?s:"",o=void 0!==n?n:F.test(e[t])?e[t].match(F)[0]:"",g=""!==o?a.filter(e=>e[0]===o)[0][1]:"",D=new RegExp(`^${o}`),i=new RegExp(`${g}$`);t!==e.length-1?l(!0):l(!1)}let t=0,$=!1,p=!1;r()})}let r=a.map(e=>e[0]).join(""),F=new RegExp(`^(?<![　 ])[${r}]`);return"normal"===n?e.split(s).map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===n?u(e.split(s)):"normal"!==n&&"few"!==n?e.split(s):void 0}function $(e){return"parse"===l?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"delete"===l?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"$1").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===l?e:void 0}let p=void 0===e?"":e,n=void 0===u?"normal":u,l=void 0===r?"parse":r,a=void 0===F?[["「","」"],["『","』"],["（","）"]]:F,c={n:(p.match(/(?<!\r)\n/g)||[]).length,r:(p.match(/\r(?!\n)/g)||[]).length,rn:(p.match(/\r\n/g)||[]).length},s=c.n>=c.r?c.n>=c.rn?"\n":"\r\n":c.r<=c.rn?"\r\n":"\r";return p=p.replace(/\r?\n|\r(?!\n)/g,s),t(p).then(e=>$(e.join("")))}