function novelparse(u,r){let F="",e=u,p=u.match(/\r\n/),t=u.match(/(?<!\r)\n/);p&&t&&p.length>t.length?(F="\r\n",e.replace(/\r?\n/g,F)):(F="\n",e.replace(/\r?\n/g,F));let l=new RegExp(`${F}+`,"g");return e=e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)\(([\u3040-\u309F\u30A0-\u30FF]+?)\)/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/([々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+)（([\u3040-\u309F\u30A0-\u30FF]+?)）/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜](.*?)[|｜]《(.*?)》/g,"$1《$2》").replace(/[|｜]《(.*?)》/g,"《$1》").replace(/[|｜]\((.*?)\)/g,"($1)").replace(/[|｜]（(.*?)）/g,"（$1）").replace(/#(.*?)__(.*?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"),"few"===r&&(e=e.replace(l,u=>u.replace(F,""))),e.split(F).map(u=>/^$/.test(u)?"<p><br></p>":`<p>${u}</p>`).join(F)}